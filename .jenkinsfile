#!groovy
properties([disableConcurrentBuilds()])
pipeline {
    agent { 
        label 'staging'
    }
    options {
        timestamps()
    }

    //environment {
        //load '.env'
    //}

    //environment {
        //SERVER_IP = ${SERVER_IP}
        //SERVER_USER = 'root'
        //SSH_KEY = credentials(${SECRET_SSH})
        //REPO_URL = ${REPOSITORY_URL}
        //WORK_DIR = '/root/'
        //DIR_NAME = 'JalurAdmin'
    //}

    stages {
        stage('Сборка') {
            steps {
                steps {
                    sh "ssh -o StrictHostKeyChecking=no root@176.113.83.11 'hostname'"
                }
                //script {
                    //sshagent(credentials: [SSH_KEY]) {
                        //sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'rm -rf ${WORK_DIR}/${DIR_NAME}'"
                        //sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'cd ${WORK_DIR} && git clone -b staging ${REPO_URL} JalurAdmin'"
                        //sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'cd ${WORK_DIR}/${DIR_NAME}'"
                        //sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'cd ${WORK_DIR}/${DIR_NAME} && cp .example.env .env'"
                        //sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'cd ${WORK_DIR}/${DIR_NAME} && docker-compose up --build -d'"
                        //sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'cd ${WORK_DIR}/${DIR_NAME} && cp sources/.env.example sources/.env'"
                        //sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'cd ${WORK_DIR}/${DIR_NAME} && docker-compose run php-fpm composer install'"
                        //sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'cd ${WORK_DIR}/${DIR_NAME} && docker-compose run node install'"
                        //sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'cd ${WORK_DIR}/${DIR_NAME} && docker-compose run node run build'"
                        //sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'cd ${WORK_DIR}/${DIR_NAME} && docker-compose run php-fpm php artisan key:generate'"
                        //sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'cd ${WORK_DIR}/${DIR_NAME} && chmod -R 777 \$PWD'"
                        //sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'cd ${WORK_DIR}/${DIR_NAME} && docker-compose run php-fpm php artisan storage:link'"
                    //}
                //}
            }
        }
    }

    post {
        success {
            echo 'Развертывание из staging прошло успешно!'
        }
        failure {
            echo 'Ошибка развёртывания!'
        }
    }
}
